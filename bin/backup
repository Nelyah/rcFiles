#!/bin/bash

# Remote server
# This should be USER@REMOTE if nothing
# is set in ssh_config
REMOTE=nas.guix.eu
BACKUP_DIR=backup

# List of files/directory to backup
LIST_BACK=($HOME/Documents $HOME/Music $HOME/Pictures)

# Get last backup date
NB_DAYS=1
for NB_DAYS in {1..180}; do
    PREV_DATE=$(date -d  "$NB_DAYS day ago" "+%d-%m-%Y")
    PREV_BACKUP=$BACKUP_DIR/backup_${PREV_DATE}

    if ssh $REMOTE stat $PREV_BACKUP &> /dev/null; then
        NB_DAYS=$((NB_DAYS+1))
    else
        break
    fi
done

DATE=$(date "+%d-%m-%Y")
BACKUP_NAME=$BACKUP_DIR/backup_${DATE}
rsync -az \
    --delete \
    --link-dest=../${PREV_BACKUP} \
    ${LIST_BACK[@]} \
    $REMOTE:$BACKUP_NAME
