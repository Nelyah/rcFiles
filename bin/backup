#!/bin/bash

USER=$1
REMOTE=$2
BACKUP_DIR=backup

# List of files/directory to backup
LIST_BACK=($HOME/Documents $HOME/Music $HOME/Pictures)

AVAIL_BACKUP=$(ssh $USER@$REMOTE "stat -c "%n" $BACKUP_DIR/*" 2> /dev/null)

# Check if there is at least one previous backup
if [[ ! -z $AVAIL_BACKUP ]]; then
    # Get last backup date
    NB_DAYS=1

    for NB_DAYS in {1..180}; do
        PREV_DATE=$(date -d  "$NB_DAYS day ago" "+%d-%m-%Y")
        PREV_BACKUP=$BACKUP_DIR/backup_${PREV_DATE}

        if [[ ! -z $(grep $PREV_BACKUP <<< $AVAIL_BACKUP) ]]; then
            break
        else
            NB_DAYS=$((NB_DAYS+1))
        fi
    done
else
    # If there is none
    PREV_BACKUP=
fi

# Proceed to actual backup
if [[ ! -z $PREV_BACKUP ]]; then
    BASE_PREVBACKUP=$(basename $PREV_BACKUP)
    DATE=$(date "+%d-%m-%Y")
    BACKUP_NAME=$BACKUP_DIR/backup_${DATE}
    rsync -az \
        --delete \
        --link-dest=../${BASE_PREVBACKUP} \
        ${LIST_BACK[@]} \
        $USER@$REMOTE:$BACKUP_NAME
fi
